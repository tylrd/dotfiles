#!/usr/bin/env bash

source ~/.git_prompt.sh

GIT_PS1_SHOWDIRTYSTATE=1
GIT_PS1_SHOWUNTRACKEDFILES=1
GIT_PS1_SHOWCOLORHINTS=1

PROMPT_COMMAND="__prompt_command;"

get_envs() {
  prompt=""
  local cyan='\[\e[1;36m\]'
  local green='\[\e[0;32m\]'

  KUBE_CONFIG_FILE=${KUBECONFIG:-"$HOME/.kube/config"}

  if [ -f "$KUBE_CONFIG_FILE" ]; then
    KUBE_CONTEXT=$(sed -n 's/current-context: \(.*\)/\1/p' $HOME/.kube/config | cut -d'_' -f4)

    if [ -n "$KUBE_CONTEXT" ]; then
      prompt+=" ${cyan}($KUBE_CONTEXT)"
    fi
  fi

  if [ -z "$GOOGLE_PROJECT" ] && [ -z "$CHEF_ENV" ]; then
    echo "$prompt"
    return
  fi

  if [ "$GOOGLE_PROJECT" = "$CHEF_ENV" ]; then
    prompt+=" ${cyan}[${GOOGLE_PROJECT}] $(printf '\xE2\x9C\xA8')"
  else
    if [ -n "$GOOGLE_PROJECT" ]; then
      prompt+=" ${green}( gcp: $GOOGLE_PROJECT )"
    fi

    if [ -n "$CHEF_ENV" ]; then
      prompt+=" ${green}( chef: $CHEF_ENV )"
    fi

  fi

  echo "$prompt"
}

__prompt_command() {
    local curr_exit="$?"
    PS1=""

    local RCol='\[\e[0m\]'
    local BYel='\[\e[1;33m\]'
    local Red='\[\e[0;31m\]'
    local Blu='\[\e[0;34m\]'

    if [ "$curr_exit" != 0 ]; then
        PS1+="${Red}\u${RCol}"
    else
        PS1+="\u"
    fi

    pwd2=$(p="${PWD#${HOME}}"; [ "${PWD}" != "${p}" ] && printf "~";IFS=/; for q in ${p:1}; do printf /${q:0:1}; done; printf "${q:1}")

    PS1+="${RCol}@\h:${Blu}$pwd2${BYel}$(__git_ps1 " (%s)")$(get_envs) ${RCol}\n$ "
}
